---
title: redis数据持久化
date: 2018-02-01 20:27:33 
tags: [Redis]
categories: work
---
Redis将内存存储和持久化存储相结合，即可提供数据访问的高效性，又可保证数据存储的安全性

<!-- more -->

## 一、Redis数据持久化机制介绍
redis中默认的持久化方案是rdb方式，该机制是值在指定时间间隔将内存中的数据集快照写入dump.rdb文件中

### 1、RDB持久化：
该机制是指在指定的时间间隔内将内存中的数据集快照写入磁盘。
在redis安装目录/bin/dump.rdb 文件中有如下设置：
![redis持久化-rdb方式](/images/redis持久化-rdb方式.png)

我们也可以通过配置文件来修改redis服务器快照频率，使用vim redis安装目录/bin/dump.rdb文件，修改上图所标志的，假设将60s内修改10个key发生变化，产生快照。当我们使用rm -rf dump.rdb 删除该文件时，在一分钟内设置10个值，会发现dump.rdb有重新自动创建了

**注意：dump.rdb文件生成的位置,它是设置是在redis.conf文件中 "dir ./" 这段配置指的是服务器启动时的当前路径。即如果在root目录下直接启动redis，该文件就产生在root目录下！！**

### 2、AOF(append only file)持久化:
该机制将以日志的形式记录服务器所处理的每一个写操作，在Redis服务器启动之初会读取该文件来重新构建数据库，以保证启动后数据库中的数据是完整的。

AOF日志持久化机制的开启以及三种同步方式配置：
![开启aof方式](/images/redis持久化-开启aof方式.png)

开启aof缓存方案后，向redis中缓存后，就可以看到bin/appendonly.aof 文件，查看该配置文件就可以看到刚刚设置进去的值。  

### 3、同时应用AOF和RDB。
### 4、无持久化：
可通过配置的方式禁用Redis服务器的持久化功能，不推荐
  

## 二、RDB与AOF对比总结 
### RDB优势
- 数据的备份和恢复非常方便，因为一个数据库只有一个持久化文件
- 性能最大化。对于Redis的服务进程而言，在开始持久化时，它唯一需要做的只是fork出子进程，之后再由子进程完成这些持久化的工作，这样就可以极大的避免服务进程执行IO操作了。
- 相比于AOF机制，如果数据集很大，RDB的启动效率会更高。
    
### RDB劣势
- 系统一旦在定时持久化之前出现宕机现象，此前没有来得及写入磁盘的数据都将丢失。
- 由于RDB是通过fork子进程来协助完成数据持久化工作的，因此，如果当数据集较大时，可能会导致整个服务器停止服务几百毫秒，甚至是1秒钟。

### AOF优势 
- 该机制可以带来更高的数据安全性，即数据持久性。Redis中提供了3种同步策略，即每秒同步、每修改同步和不同步。
- 对日志文件的写入操作采用的是append模式，因此在写入过程中即使出现宕机现象，也不会破坏日志文件中已经存在的内容。
- 如果日志过大，Redis可以自动启用rewrite机制迅速“瘦身”(也可手动触发aof的rewrite操作，命令： bgrewriteaof)
- AOF日志格式清晰、易于理解，很容易用AOF日志文件完成数据的重建。
    
### AOF劣势 
- 对于相同数量的数据集而言，AOF文件通常要大于RDB文件。
- 根据同步策略的不同，AOF在运行效率上往往会慢于RDB。总之，每秒同步策略的效率是比较高的，同步禁用策略的效率和RDB一样高效。

